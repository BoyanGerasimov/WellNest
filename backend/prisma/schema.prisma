// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User Model
model User {
  id                String    @id @default(uuid())
  name              String
  email             String    @unique
  password          String?   // Nullable for OAuth users
  avatar            String?
  dateOfBirth       DateTime?
  gender            String?   // male, female, other
  height            Float?    // in cm
  startingWeight    Float?    // in kg (set once during onboarding)
  currentWeight     Float?    // in kg
  goalWeight        Float?    // in kg
  activityLevel     String?   // sedentary, lightly_active, moderately_active, very_active, extremely_active
  dailyCalorieGoal  Int?
  role              String    @default("user") // user, admin
  isEmailVerified   Boolean   @default(false)
  lastLogin         DateTime?
  lastWeightCheckinAt DateTime? // last time user recorded their weight
  
  // OAuth fields
  oauthProvider     String?   // google, github
  oauthId           String?
  
  // Relations
  workouts          Workout[]
  meals             Meal[]
  weightEntries     WeightEntry[]
  achievements      Achievement[]
  forumPosts        ForumPost[]
  forumComments     ForumComment[]
  forumLikes        ForumLike[]
  chatMessages      ChatMessage[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([email])
  @@map("users")
}

// Weight Entry Model (weekly check-ins + history)
model WeightEntry {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weight     Float
  recordedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([userId, recordedAt(sort: Desc)])
  @@map("weight_entries")
}

// Workout Model
model Workout {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  date          DateTime  @default(now())
  exercises     Json      // Array of exercise objects
  totalDuration Int       @default(0) // in minutes
  caloriesBurned Int     @default(0)
  notes         String?
  tags          String[] @default([])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId, date(sort: Desc)])
  @@map("workouts")
}

// Meal Model
model Meal {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  type          String    // breakfast, lunch, dinner, snack
  date          DateTime  @default(now())
  foodItems     Json      // Array of food item objects
  totalCalories Float     @default(0)
  totalProtein  Float     @default(0)
  totalCarbs    Float     @default(0)
  totalFats     Float     @default(0)
  notes         String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId, date(sort: Desc)])
  @@map("meals")
}

// Achievement Model
model Achievement {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // workout_streak, calorie_goal, weight_loss, workout_count, milestone
  title       String
  description String
  icon        String   @default("üèÜ")
  points      Int      @default(0)
  unlockedAt DateTime @default(now())
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, unlockedAt(sort: Desc)])
  @@map("achievements")
}

// Forum Post Model
model ForumPost {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  content   String
  category  String         // workout, nutrition, motivation, questions, general
  tags      String[]       @default([])
  views     Int            @default(0)
  isPinned  Boolean        @default(false)
  comments  ForumComment[]
  likes     ForumLike[]
  
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([category, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("forum_posts")
}

// Forum Comment Model
model ForumComment {
  id        String   @id @default(uuid())
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  likes     ForumLike[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId, createdAt(sort: Asc)])
  @@map("forum_comments")
}

// Forum Like Model (for both posts and comments)
model ForumLike {
  id        String       @id @default(uuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String?
  post      ForumPost?   @relation(fields: [postId], references: [id], onDelete: Cascade)
  commentId String?
  comment   ForumComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  createdAt DateTime     @default(now())

  @@unique([userId, postId, commentId])
  @@map("forum_likes")
}

// Chat Message Model
model ChatMessage {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   String
  response  String
  timestamp DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, timestamp(sort: Desc)])
  @@map("chat_messages")
}

